<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados da Sondagem APLO - Infográfico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Adicionado o plugin chartjs-plugin-datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .stat-card h3 {
            color: #003f5c;
        }
        .header-bg {
            background-color: #003f5c;
        }
        .section-title {
            color: #003f5c;
        }
        /* Estilo para o modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="header-bg text-white p-8 text-center shadow-lg">
        <h1 class="text-4xl md:text-5xl font-bold mb-2">Análise da Sondagem APLO</h1>
        <p class="text-lg md:text-xl max-w-3xl mx-auto">Uma visão aprofundada sobre as opiniões e perspetivas dos membros da Associação de Profissionais de Optometria.</p>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="overview" class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-6 section-title">Visão Geral da Participação</h2>
            <p class="text-center max-w-2xl mx-auto mb-8 text-lg text-gray-600">
                Esta sondagem obteve uma participação significativa, fornecendo uma amostra estatisticamente fiável das opiniões dos membros. Os dados seguintes estabelecem a base para a análise, refletindo o forte envolvimento da comunidade.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="stat-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-5xl font-bold mb-2">27,7%</h3>
                    <p class="text-gray-600 font-semibold">Taxa de Participação</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-5xl font-bold mb-2">95,15%</h3>
                    <p class="text-gray-600 font-semibold">Nível de Confiança</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-5xl font-bold mb-2">4,85%</h3>
                    <p class="text-gray-600 font-semibold">Margem de Erro</p>
                </div>
            </div>
        </section>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Critérios de Admissão de Novos Membros</h3>
                <p class="text-gray-600 mb-4">A maioria dos membros acredita que a titularidade de uma licenciatura em Optometria é o critério suficiente para a admissão, indicando uma forte confiança nas qualificações académicas atuais.</p>
                <div class="chart-container">
                    <canvas id="admissionCriteriaChart"></canvas>
                </div>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="generateAnalysis('admission')">Gerar Análise ✨</button>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Opinião sobre a Formação Contínua (CFCO)</h3>
                 <p class="text-gray-600 mb-4">A questão da formação contínua gera opiniões diversas. A visão mais partilhada é a de manter os 10 créditos, mas com maior flexibilidade, eliminando a suspensão no primeiro ano de incumprimento.</p>
                <div class="chart-container">
                    <canvas id="cfcoOpinionChart"></canvas>
                </div>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="generateAnalysis('cfco')">Gerar Análise ✨</button>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 md:col-span-2">
                 <h3 class="text-xl font-bold text-center mb-1 section-title">Aprofundando a Formação Contínua</h3>
                 <p class="text-gray-600 mb-6 text-center">Analisando os dados de forma agregada, a vasta maioria (79%) apoia a manutenção da formação contínua, embora exista um debate sobre a quantidade de créditos necessários.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="flex flex-col items-center">
                        <h4 class="font-semibold text-lg mb-2">Manter vs. Eliminar CFCO</h4>
                        <div class="chart-container h-64 md:h-72">
                            <canvas id="maintainVsEliminateChart"></canvas>
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <h4 class="font-semibold text-lg mb-2">Manter 10 Créditos vs. Reduzir</h4>
                        <div class="chart-container h-64 md:h-72">
                            <canvas id="maintainVsReduceChart"></canvas>
                        </div>
                    </div>
                </div>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="generateAnalysis('cfco_deep_dive')">Gerar Análise ✨</button>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Motivação para Participar em Conferências</h3>
                <p class="text-gray-600 mb-4">A principal força motriz para a participação em eventos é a atualização de conhecimentos, superando largamente o convívio e o cumprimento formal dos créditos. Isto sublinha o valor atribuído ao conteúdo científico.</p>
                <div class="chart-container">
                    <canvas id="conferenceMotivationChart"></canvas>
                </div>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="generateAnalysis('conference_motivation')">Gerar Análise ✨</button>
            </div>

            <!-- Nova secção para Análise Composta de Conferências Abertas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Análise Composta: Conferências Abertas</h3>
                <p class="text-gray-600 mb-4">Ao agrupar as motivações, é evidente que a maioria dos participantes valoriza as conferências pelo seu conteúdo educacional e networking, em detrimento do cumprimento de requisitos de formação.</p>
                <div class="chart-container">
                    <canvas id="conferenceCompositeChart"></canvas>
                </div>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="generateAnalysis('conference_composite')">Gerar Análise ✨</button>
            </div>
            <!-- Fim da nova secção -->

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Modernização das Prescrições Manuais</h3>
                <p class="text-gray-600 mb-4">Há um claro consenso a favor da modernização. Quase 80% dos membros preferem um sistema de descarregamento digital de modelos validados, indicando um desejo por maior eficiência e autonomia.</p>
                <div class="chart-container">
                    <canvas id="prescriptionMethodChart"></canvas>
                </div>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="generateAnalysis('prescription_method')">Gerar Análise ✨</button>
            </div>
        </div>

    </main>
    
    <footer class="mt-12 text-center p-6 bg-gray-100 border-t">
        <p class="text-gray-600">Infográfico gerado com base na sondagem realizada aos membros da APLO.</p>
    </footer>

    <!-- Modal para exibir a análise da Gemini API -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Análise Gerada ✨</h2>
            <p id="analysisText" class="text-gray-700"></p>
            <div id="analysisLoading" class="hidden text-center mt-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <p>A gerar análise...</p>
            </div>
        </div>
    </div>


    <script>
        // Registrar o plugin de datalabels globalmente
        Chart.register(ChartDataLabels);

        document.addEventListener('DOMContentLoaded', () => {

            const colorPalette = ['#003f5c', '#665191', '#d45087', '#ffa600'];
            const lightColorPalette = ['#2f4b7c', '#a05195', '#f95d6a', '#ff7c43'];

            function wrapLabels(label, maxWidth) {
                if (typeof label !== 'string' || label.length <= maxWidth) {
                    return label;
                }
                const words = label.split(' ');
                const lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length > maxWidth) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                });
                lines.push(currentLine.trim());
                return lines;
            }

            const tooltipTitleCallback = (tooltipItems) => {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) {
                    return label.join(' ');
                }
                return label;
            };

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback
                        }
                    }
                }
            };
            
            const commonBarOptions = {
                ...commonChartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            display: false // Remover os números do eixo Y
                        },
                        grid: {
                            display: false // Remover as linhas de grelha do eixo Y
                        }
                    },
                    x: {
                        ticks: {
                           display: false // Remover os números do eixo X
                        },
                        grid: {
                            display: false // Remover as linhas de grelha do eixo X
                        }
                    }
                },
                 indexAxis: 'y',
                 plugins: {
                    datalabels: {
                        formatter: (value, context) => {
                            return value + '%';
                        },
                        align: 'end', // Alinhar o texto no final da barra
                        anchor: 'end', // Ancorar o texto no final da barra
                        color: '#333', // Cor do texto
                        font: {
                            weight: 'bold'
                        },
                        offset: 4 // Pequeno offset para não ficar colado à barra
                    }
                }
            };

            const admissionData = {
                labels: ['Apenas Licenciatura em Optometria', 'Curso/Exame de Admissão Obrigatório'],
                datasets: [{
                    label: 'Critério de Admissão',
                    data: [63.4, 36.6],
                    backgroundColor: [colorPalette[0], colorPalette[2]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('admissionCriteriaChart'), {
                type: 'doughnut',
                data: admissionData,
                options: commonChartOptions
            });

            const cfcoData = {
                labels: [
                    wrapLabels('Manter 10 CFCO, mas sem suspensão no 1º incumprimento', 30),
                    'Eliminar a obrigatoriedade de CFCO',
                    'Reduzir o número de CFCO anuais',
                    'Manter 10 CFCO como adequado'
                ],
                datasets: [{
                    label: 'Opinião sobre os 10 CFCO Anuais (%)',
                    data: [41.4, 21.0, 20.0, 17.6],
                    backgroundColor: colorPalette,
                    borderColor: colorPalette,
                    borderWidth: 1
                }]
            };
             new Chart(document.getElementById('cfcoOpinionChart'), {
                type: 'bar',
                data: cfcoData,
                options: {
                    ...commonBarOptions,
                    plugins: {
                        ...commonBarOptions.plugins,
                        legend: { display: false }
                    }
                }
            });

            const conferenceData = {
                labels: [
                    'Aprender e atualizar conhecimentos', 
                    'Conviver e partilhar experiências', 
                    'Cumprir os créditos (CFCO)', 
                    'Nenhuma das anteriores'
                ],
                datasets: [{
                    label: 'Principal Motivação (%)',
                    data: [52.9, 20.7, 19.3, 7.1],
                    backgroundColor: lightColorPalette,
                    borderColor: lightColorPalette,
                    borderWidth: 1
                }]
            };
            new Chart(document.getElementById('conferenceMotivationChart'), {
                type: 'bar',
                data: conferenceData,
                options: {
                    ...commonBarOptions,
                    plugins: {
                        ...commonBarOptions.plugins,
                        legend: { display: false }
                    }
                }
            });

            // Dados para o novo gráfico de Análise Composta de Conferências Abertas
            const conferenceCompositeData = {
                labels: ['Aprender em Optometria ou Conviver', 'Cumprir CFCO'],
                datasets: [{
                    data: [79.2, 20.8],
                    backgroundColor: [colorPalette[0], colorPalette[3]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('conferenceCompositeChart'), {
                type: 'pie',
                data: conferenceCompositeData,
                options: commonChartOptions
            });
            
            const prescriptionData = {
                labels: ['Permitir descarregamento de modelo digital', 'Manter sistema atual com gráfica'],
                datasets: [{
                    label: 'Opinião sobre Prescrições',
                    data: [79.0, 21.0],
                    backgroundColor: [colorPalette[1], colorPalette[3]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('prescriptionMethodChart'), {
                type: 'doughnut',
                data: prescriptionData,
                options: commonChartOptions
            });
            
            const maintainVsEliminateData = {
                labels: ['Manter Formação Contínua', 'Eliminar Formação Contínua'],
                datasets: [{
                    data: [79.0, 21.0],
                    backgroundColor: [colorPalette[0], colorPalette[2]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('maintainVsEliminateChart'), {
                type: 'pie',
                data: maintainVsEliminateData,
                options: commonChartOptions
            });
            
            const maintainVsReduceData = {
                labels: ['Manter número de 10 CFCO', 'Reduzir número de CFCO'],
                datasets: [{
                    data: [74.7, 25.3],
                    backgroundColor: [colorPalette[1], colorPalette[3]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('maintainVsReduceChart'), {
                type: 'pie',
                data: maintainVsReduceData,
                options: commonChartOptions
            });
        });

        // Funções para o modal
        function openModal() {
            document.getElementById('analysisModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('analysisModal').style.display = 'none';
            document.getElementById('analysisText').textContent = '';
            document.getElementById('analysisLoading').classList.add('hidden');
        }

        async function generateAnalysis(section) {
            openModal();
            document.getElementById('analysisLoading').classList.remove('hidden');
            document.getElementById('analysisText').textContent = '';

            let prompt = "";
            let dataForPrompt = {};

            // Preparar os dados para o prompt com base na secção
            if (section === 'admission') {
                dataForPrompt = {
                    title: "Critérios de Admissão de Novos Membros",
                    options: [
                        { label: 'Apenas a titularidade de licenciatura em Optometria válida nos termos da legislação portuguesa', value: 63.4 },
                        { label: 'Deve ser obrigatória a realização de um curso de admissão e/ou exame de admissão', value: 36.6 }
                    ]
                };
            } else if (section === 'cfco') {
                dataForPrompt = {
                    title: "Opinião sobre a Formação Contínua (CFCO)",
                    options: [
                        { label: 'Manter 10 CFCO, mas sem suspensão no 1º incumprimento', value: 41.4 },
                        { label: 'Eliminar a obrigatoriedade de CFCO', value: 21.0 },
                        { label: 'Reduzir o número de CFCO anuais', value: 20.0 },
                        { label: 'Manter 10 CFCO como adequado', value: 17.6 }
                    ]
                };
            } else if (section === 'cfco_deep_dive') {
                dataForPrompt = {
                    title: "Aprofundando a Formação Contínua",
                    subSections: [
                        {
                            title: "Manter vs. Eliminar CFCO",
                            options: [
                                { label: 'Manter Formação Contínua', value: 79.0 },
                                { label: 'Eliminar Formação Contínua', value: 21.0 }
                            ]
                        },
                        {
                            title: "Manter 10 Créditos vs. Reduzir",
                            options: [
                                { label: 'Manter número de 10 CFCO', value: 74.7 },
                                { label: 'Reduzir número de CFCO', value: 25.3 }
                            ]
                        }
                    ]
                };
            } else if (section === 'conference_motivation') {
                dataForPrompt = {
                    title: "Motivação para Participar em Conferências",
                    options: [
                        { label: 'Aprender e atualizar conhecimentos científicos e clínicos em Optometria', value: 52.9 },
                        { label: 'Conviver, partilhar experiências e contactar com colegas da profissão', value: 20.7 },
                        { label: 'Cumprir os 10 Créditos de Formação Contínua em Optometria (CFCO)', value: 19.3 },
                        { label: 'Nenhuma das anteriores', value: 7.1 }
                    ]
                };
            } else if (section === 'conference_composite') {
                dataForPrompt = {
                    title: "Análise Composta: Conferências Abertas",
                    options: [
                        { label: 'Aprender em Optometria ou Conviver', value: 79.2 },
                        { label: 'Cumprir CFCO', value: 20.8 }
                    ]
                };
            } else if (section === 'prescription_method') {
                dataForPrompt = {
                    title: "Modernização das Prescrições Manuais",
                    options: [
                        { label: 'Permitir o descarregamento direto na área de membro, de um modelo com validação eletrónica oficial da APLO, para impressão e preenchimento manual', value: 79.0 },
                        { label: 'Manter o modelo e regime atual, com produção e envio centralizado pela gráfica', value: 21.0 }
                    ]
                };
            }

            if (dataForPrompt.title) {
                prompt = `Dada a seguinte informação da sondagem da APLO sobre "${dataForPrompt.title}":\n`;
                if (dataForPrompt.options) {
                    dataForPrompt.options.forEach(opt => {
                        prompt += `- ${opt.label}: ${opt.value}%\n`;
                    });
                } else if (dataForPrompt.subSections) {
                    dataForPrompt.subSections.forEach(sub => {
                        prompt += `\nSub-secção: ${sub.title}\n`;
                        sub.options.forEach(opt => {
                            prompt += `- ${opt.label}: ${opt.value}%\n`;
                        });
                    });
                }
                prompt += "\nPor favor, forneça uma análise concisa e de alto nível (máximo 50 palavras) para apresentar aos membros da APLO, destacando o principal *insight*.";
            }

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    document.getElementById('analysisText').textContent = text;
                } else {
                    document.getElementById('analysisText').textContent = "Não foi possível gerar a análise. Tente novamente.";
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                document.getElementById('analysisText').textContent = "Ocorreu um erro ao gerar a análise. Verifique a sua ligação ou tente mais tarde.";
            } finally {
                document.getElementById('analysisLoading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
