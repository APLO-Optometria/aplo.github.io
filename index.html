<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados da Sondagem APLO - Infográfico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Adicionado o plugin chartjs-plugin-datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .stat-card h3 {
            color: #003f5c;
        }
        .header-bg {
            background-color: #003f5c;
        }
        .section-title {
            color: #003f5c;
        }
        /* Estilo para o modal (mantido mas não será acionado, pode ser removido se não houver planos futuros para ele) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="header-bg text-white p-8 text-center shadow-lg">
        <h1 class="text-4xl md:text-5xl font-bold mb-2">Análise da Sondagem APLO</h1>
        <p class="text-lg md:text-xl max-w-3xl mx-auto">Uma visão aprofundada sobre as opiniões e perspetivas dos membros da Associação de Profissionais Licenciados de Optometria.</p>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="overview" class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-6 section-title">Visão Geral da Participação</h2>
            <p class="text-center max-w-2xl mx-auto mb-8 text-lg text-gray-600">
                Esta sondagem obteve uma participação significativa, fornecendo uma amostra estatisticamente fiável das opiniões dos membros. Mais de um quarto do total de membros efectivos participou. Os dados seguintes estabelecem a base para a análise, refletindo o forte envolvimento da comunidade.
            </p>
            <div class="flex justify-center flex-wrap gap-6 text-center"> <!-- Alterado para flex justify-center -->
                <div class="stat-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-5xl font-bold mb-2">27,7%</h3>
                    <p class="text-gray-600 font-semibold">Taxa de Participação</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-5xl font-bold mb-2">95,15%</h3>
                    <p class="text-gray-600 font-semibold">Nível de Confiança</p>
                </div>
            </div>
        </section>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Critérios de Admissão de Novos Membros</h3>
                <p class="text-gray-600 mb-4">A maioria dos membros acredita que a titularidade de uma licenciatura em Optometria é o critério suficiente para a admissão, indicando uma forte confiança nas qualificações académicas atuais.</p>
                <div class="chart-container">
                    <canvas id="admissionCriteriaChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Opinião sobre a Formação Contínua (CFCO)</h3>
                 <p class="text-gray-600 mb-4">A questão da formação contínua gera opiniões diversas. A visão mais partilhada é a de manter os 10 créditos, mas com maior flexibilidade, eliminando a suspensão no primeiro ano de incumprimento.</p>
                <div class="chart-container">
                    <canvas id="cfcoOpinionChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 md:col-span-2">
                 <h3 class="text-xl font-bold text-center mb-1 section-title">Aprofundando a Formação Contínua</h3>
                 <p class="text-gray-600 mb-6 text-center">Analisando os dados de forma agregada, a vasta maioria (79%) apoia a manutenção da formação contínua, embora exista um debate sobre a forma e quantidade de CFCO.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="flex flex-col items-center">
                        <h4 class="font-semibold text-lg mb-2">Manter vs. Eliminar CFCO</h4>
                        <div class="chart-container h-64 md:h-72">
                            <canvas id="maintainVsEliminateChart"></canvas>
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <h4 class="font-semibold text-lg mb-2">Manter 10 Créditos vs. Reduzir</h4>
                        <div class="chart-container h-64 md:h-72">
                            <canvas id="maintainVsReduceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Motivação para Participar em Conferências</h3>
                <p class="text-gray-600 mb-4">A principal força motriz para a participação em eventos é a atualização de conhecimentos, superando largamente o convívio e o cumprimento formal dos créditos. Isto sublinha o valor atribuído ao conteúdo formativo em optometria.</p>
                <div class="chart-container">
                    <canvas id="conferenceMotivationChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Análise Composta: Conferências Abertas</h3>
                <p class="text-gray-600 mb-4">Ao agrupar as motivações, é evidente que a maioria dos participantes valoriza as conferências pelo seu conteúdo educacional e networking, em detrimento do cumprimento de requisitos de formação.</p>
                <div class="chart-container">
                    <canvas id="conferenceCompositeChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-1 section-title">Modernização das Prescrições Manuais</h3>
                <p class="text-gray-600 mb-4">Há um claro consenso a favor da modernização. Quase 80% dos membros preferem um sistema de descarregamento digital de modelos validados, indicando um desejo por maior eficiência e autonomia.</p>
                <div class="chart-container">
                    <canvas id="prescriptionMethodChart"></canvas>
                </div>
            </div>
        </div>

    </main>
    
    <footer class="mt-12 text-center p-6 bg-gray-100 border-t">
        <p class="text-gray-600">Infográfico gerado com base na sondagem realizada aos membros da APLO.</p>
    </footer>

    <!-- Modal para exibir a análise (mantido mas não será acionado) -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Análise Gerada ✨</h2>
            <p id="analysisText" class="text-gray-700"></p>
            <div id="analysisLoading" class="hidden text-center mt-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <p>A gerar análise...</p>
            </div>
        </div>
    </div>


    <script>
        // Registrar o plugin de datalabels globalmente
        Chart.register(ChartDataLabels);

        document.addEventListener('DOMContentLoaded', () => {

            const colorPalette = ['#003f5c', '#665191', '#d45087', '#ffa600'];
            const lightColorPalette = ['#2f4b7c', '#a05195', '#f95d6a', '#ff7c43'];

            function wrapLabels(label, maxWidth) {
                if (typeof label !== 'string' || label.length <= maxWidth) {
                    return label;
                }
                const words = label.split(' ');
                const lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length > maxWidth) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                });
                lines.push(currentLine.trim());
                return lines;
            }

            const tooltipTitleCallback = (tooltipItems) => {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) {
                    return label.join(' ');
                }
                return label;
            };

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback
                        }
                    }
                }
            };
            
            const commonBarOptions = {
                ...commonChartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            display: false // Remover os números do eixo Y
                        },
                        grid: {
                            display: false // Remover as linhas de grelha do eixo Y
                        }
                    },
                    x: {
                        ticks: {
                           display: false // Remover os números do eixo X
                        },
                        grid: {
                            display: false // Remover as linhas de grelha do eixo X
                        }
                    }
                },
                 indexAxis: 'y',
                 plugins: {
                    datalabels: {
                        formatter: (value, context) => {
                            return value + '%';
                        },
                        align: 'end', // Alinhar o texto no final da barra
                        anchor: 'end', // Ancorar o texto no final da barra
                        color: '#333', // Cor do texto
                        font: {
                            weight: 'bold'
                        },
                        offset: 4 // Pequeno offset para não ficar colado à barra
                    },
                    legend: { // Configuração de legenda para gráficos de barra
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const backgroundColor = Array.isArray(dataset.backgroundColor) ? dataset.backgroundColor[i] : dataset.backgroundColor;
                                        const borderColor = Array.isArray(dataset.borderColor) ? dataset.borderColor[i] : dataset.borderColor;

                                        return {
                                            text: Array.isArray(label) ? label.join(' ') : label,
                                            fillStyle: backgroundColor,
                                            strokeStyle: borderColor,
                                            lineWidth: dataset.borderWidth,
                                            hidden: chart.getDatasetMeta(0).data[i].hidden,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    }
                }
            };

            const admissionData = {
                labels: ['Apenas Licenciatura em Optometria', 'Curso/Exame de Admissão Obrigatório'],
                datasets: [{
                    label: 'Critério de Admissão',
                    data: [63.4, 36.6],
                    backgroundColor: [colorPalette[0], colorPalette[2]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('admissionCriteriaChart'), {
                type: 'doughnut',
                data: admissionData,
                options: commonChartOptions
            });

            const cfcoData = {
                labels: [
                    wrapLabels('Manter 10 CFCO, mas sem suspensão imediata', 30),
                    'Eliminar a obrigatoriedade de CFCO',
                    'Reduzir o número de CFCO anuais',
                    'Manter 10 CFCO como adequado'
                ],
                datasets: [{
                    label: 'Opinião sobre os 10 CFCO Anuais (%)', // Este label é para o tooltip, não para a legenda principal
                    data: [41.4, 21.0, 20.0, 17.6],
                    backgroundColor: colorPalette,
                    borderColor: colorPalette,
                    borderWidth: 1
                }]
            };
             new Chart(document.getElementById('cfcoOpinionChart'), {
                type: 'bar',
                data: cfcoData,
                options: commonBarOptions // Agora commonBarOptions inclui a lógica de legenda personalizada
            });

            const conferenceData = {
                labels: [
                    'Aprender e atualizar conhecimentos', 
                    'Conviver e partilhar experiências', 
                    'Cumprir os créditos (CFCO)', 
                    'Nenhuma das anteriores'
                ],
                datasets: [{
                    label: 'Principal Motivação (%)', // Este label é para o tooltip, não para a legenda principal
                    data: [52.9, 20.7, 19.3, 7.1],
                    backgroundColor: lightColorPalette,
                    borderColor: lightColorPalette,
                    borderWidth: 1
                }]
            };
            new Chart(document.getElementById('conferenceMotivationChart'), {
                type: 'bar',
                data: conferenceData,
                options: commonBarOptions // Agora commonBarOptions inclui a lógica de legenda personalizada
            });

            const conferenceCompositeData = {
                labels: ['Aprender em Optometria ou Conviver', 'Cumprir CFCO'],
                datasets: [{
                    data: [79.2, 20.8],
                    backgroundColor: [colorPalette[0], colorPalette[3]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('conferenceCompositeChart'), {
                type: 'pie',
                data: conferenceCompositeData,
                options: commonChartOptions
            });
            
            const prescriptionData = {
                labels: ['Permitir descarregamento de modelo digital', 'Manter sistema atual com gráfica'],
                datasets: [{
                    label: 'Opinião sobre Prescrições',
                    data: [79.0, 21.0],
                    backgroundColor: [colorPalette[1], colorPalette[3]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('prescriptionMethodChart'), {
                type: 'doughnut',
                data: prescriptionData,
                options: commonChartOptions
            });
            
            const maintainVsEliminateData = {
                labels: ['Manter Formação Contínua', 'Eliminar Formação Contínua'],
                datasets: [{
                    data: [79.0, 21.0],
                    backgroundColor: [colorPalette[0], colorPalette[2]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('maintainVsEliminateChart'), {
                type: 'pie',
                data: maintainVsEliminateData,
                options: commonChartOptions
            });
            
            const maintainVsReduceData = {
                labels: ['Manter número de 10 CFCO', 'Reduzir número de CFCO'],
                datasets: [{
                    data: [74.7, 25.3],
                    backgroundColor: [colorPalette[1], colorPalette[3]],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };
            new Chart(document.getElementById('maintainVsReduceChart'), {
                type: 'pie',
                data: maintainVsReduceData,
                options: commonChartOptions
            });
        });

        // Funções para o modal (mantidas mas não serão acionadas pelos botões)
        function openModal() {
            document.getElementById('analysisModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('analysisModal').style.display = 'none';
            document.getElementById('analysisText').textContent = '';
            document.getElementById('analysisLoading').classList.add('hidden');
        }

        // A função generateAnalysis() não é mais chamada pelos botões
        async function generateAnalysis(section) {
            // Este código não será executado sem os botões que o chamam.
            // É mantido para referência futura.
            console.log(`Análise gerada para a secção: ${section}`);
        }
    </script>
</body>
</html>
